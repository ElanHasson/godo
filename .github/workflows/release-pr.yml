name: Release PR

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. v1.8.0)'
        required: true
      changelog1:
        description: 'Changelog entry 1 (Markdown bullet)'
        required: true
      changelog2:
        description: 'Changelog entry 2 (optional)'
        required: false
      changelog3:
        description: 'Changelog entry 3 (optional)'
        required: false
      changelog4:
        description: 'Changelog entry 4 (optional)'
        required: false
      changelog5:
        description: 'Changelog entry 5 (optional)'
        required: false

        type: string

env:
  VERSION_PREFIX: release

jobs:
  release-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Install github-changelog-generator
        run: |
          go install github.com/digitalocean/github-changelog-generator@latest
        env:
          GO111MODULE: on

      - name: Generate CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          github-changelog-generator -org digitalocean -repo godo

      - name: Update libraryVersion in godo.go
        run: |
          sed -i -E "s/^(var libraryVersion = \")[^\"]+(\")/\1${{ github.event.inputs.version }}\2/" godo.go

      - name: Get latest commit on main
        id: main_sha
        run: |
          git fetch origin main
          sha=$(git rev-parse --short origin/main)
          echo "sha=$sha" >> $GITHUB_OUTPUT

      - name: Create release branch
        run: |
          branch="${VERSION_PREFIX}/${{ github.event.inputs.version }}"
          git checkout -b "$branch"

      - name: Commit changes
        run: |
          git add CHANGELOG.md godo.go
          git commit -m "Release ${{ github.event.inputs.version }}: update CHANGELOG and libraryVersion"

      - name: Push branch
        run: |
          branch="${VERSION_PREFIX}/${{ github.event.inputs.version }}"
          git push origin "$branch"

      - name: Create Pull Request with gh CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            version="${{ github.event.inputs.version }}"
            branch="${VERSION_PREFIX}/${version}"
            short_sha="${{ steps.main_sha.outputs.sha }}"

            changelog=$(printf "%s\n%s\n%s\n%s\n%s\n" \
            "${{ github.event.inputs.changelog1 }}" \
            "${{ github.event.inputs.changelog2 }}" \
            "${{ github.event.inputs.changelog3 }}" \
            "${{ github.event.inputs.changelog4 }}" \
            "${{ github.event.inputs.changelog5 }}")

            gh pr create \
            --base main \
            --head "$branch" \
            --title "Release ${version} (${short_sha})" \
            --body <<EOF
            This PR updates the CHANGELOG and libraryVersion for ${version}.

            Changelog:
            ${changelog}
            EOF
